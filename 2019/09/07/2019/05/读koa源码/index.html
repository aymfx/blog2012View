<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <title>koaæºç èµ·èˆªç¯‡ | Aymfx&#39;s Blog</title>
  
  <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1408911_ujc2i49ntb.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
  <body>
    <div class='container'>
      <header id="header">
  <section class='header-main'>
    <div class='outer'>
        <a href="/" class="logo">Aymfx's Blog</a> 
      <nav class="navbar">
        
        <a href="/" class="menu-item-link">é¦–é¡µ</a>
        
        <a href="/archives" class="menu-item-link">å½’æ¡£</a>
        
        <a href="/tags" class="menu-item-link">æ ‡ç­¾</a>
        
        <a href="/about" class="menu-item-link">å…³äºæˆ‘</a>
        
        <a href="/photos" class="menu-item-link">ç›¸å†Œ</a>
        
        <a href="https://github.com/aymfx" class="menu-item-link">äº¤å‹</a>
        
      </nav>
    </div>
  </section>
</header>
    <main class="main">
      <div class='post-detail'>
    <div id="toc" class='left'>
    <h4>
        æ–‡ç« ç›®å½•
    </h4>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç çš„ç»“æ„"><span class="toc-text">æºç çš„ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å…¥å£æ–‡ä»¶"><span class="toc-text">å…¥å£æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å…ˆå¯¹-application-çš„å¼•å…¥çš„åŒ…æ–‡ä»¶è¿›è¡Œåˆ†æ-gt"><span class="toc-text">å…ˆå¯¹ application çš„å¼•å…¥çš„åŒ…æ–‡ä»¶è¿›è¡Œåˆ†æ ==&gt;</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#is-generator-function-åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…"><span class="toc-text">is-generator-function åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#debug-ç”¨äºè°ƒè¯•-åŒæ—¶å¯ä»¥çœ‹åˆ°è°ƒæ ˆæ¶ˆè€—çš„æ—¶é—´"><span class="toc-text">debug ç”¨äºè°ƒè¯• åŒæ—¶å¯ä»¥çœ‹åˆ°è°ƒæ ˆæ¶ˆè€—çš„æ—¶é—´</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#on-finished-http-è¯·æ±‚ç»“æŸ-å®Œæˆ-æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ"><span class="toc-text">on-finished http è¯·æ±‚ç»“æŸ å®Œæˆ æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#statuses-çŠ¶æ€-ğŸ"><span class="toc-text">statuses çŠ¶æ€ ğŸ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#only-ç™½åå•è®¾ç½®-ç±»ä¼¼æ²™ç›’"><span class="toc-text">only ç™½åå•è®¾ç½® ç±»ä¼¼æ²™ç›’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#applicaion-ç±»-å…¥å£ç±»"><span class="toc-text">applicaion ç±» å…¥å£ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å‡½æ•°å†…éƒ¨åˆ†æ"><span class="toc-text">å‡½æ•°å†…éƒ¨åˆ†æ</span></a></li></ol></li></ol>
</div>
    <article class="post-detail animated slideInDown right">
        <div class="post-title">
          <h2 class="title">koaæºç èµ·èˆªç¯‡</h2>
        </div>
         <div class="post-meta"> 
          <i class='iconfont iconriqi'></i>
          <span class="post-time">2019-09-07</span>
        </div>
        <div class="article-container">
          <blockquote>
<p>å­¦ä¹ çš„koaæºç </p>
</blockquote>
<a id="more"></a>  

<h2 id="æºç çš„ç»“æ„"><a href="#æºç çš„ç»“æ„" class="headerlink" title="æºç çš„ç»“æ„"></a>æºç çš„ç»“æ„</h2><ul>
<li>application.js</li>
<li>context.js</li>
<li>request.js</li>
<li>response.js</li>
</ul>
<h2 id="å…¥å£æ–‡ä»¶"><a href="#å…¥å£æ–‡ä»¶" class="headerlink" title="å…¥å£æ–‡ä»¶"></a>å…¥å£æ–‡ä»¶</h2><blockquote>
<p>â€œmainâ€: â€œlib/application.jsâ€,</p>
</blockquote>
<h1 id="å…ˆå¯¹-application-çš„å¼•å…¥çš„åŒ…æ–‡ä»¶è¿›è¡Œåˆ†æ-gt"><a href="#å…ˆå¯¹-application-çš„å¼•å…¥çš„åŒ…æ–‡ä»¶è¿›è¡Œåˆ†æ-gt" class="headerlink" title="å…ˆå¯¹ application çš„å¼•å…¥çš„åŒ…æ–‡ä»¶è¿›è¡Œåˆ†æ ==&gt;"></a>å…ˆå¯¹ application çš„å¼•å…¥çš„åŒ…æ–‡ä»¶è¿›è¡Œåˆ†æ ==&gt;</h1><h2 id="is-generator-function-åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…"><a href="#is-generator-function-åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…" class="headerlink" title="is-generator-function åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…"></a>is-generator-function åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isGeneratorFunction = <span class="built_in">require</span>(<span class="string">'is-generator-function'</span>); <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯ç”Ÿæˆå™¨çš„åŒ…</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">s1</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s2 = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">s3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">43</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">Infinity</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s4 = s3();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(isGeneratorFunction(s1)); <span class="comment">//false</span></span><br><span class="line"><span class="built_in">console</span>.log(isGeneratorFunction(s2)); <span class="comment">//false</span></span><br><span class="line"><span class="built_in">console</span>.log(isGeneratorFunction(s3)); <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h2 id="debug-ç”¨äºè°ƒè¯•-åŒæ—¶å¯ä»¥çœ‹åˆ°è°ƒæ ˆæ¶ˆè€—çš„æ—¶é—´"><a href="#debug-ç”¨äºè°ƒè¯•-åŒæ—¶å¯ä»¥çœ‹åˆ°è°ƒæ ˆæ¶ˆè€—çš„æ—¶é—´" class="headerlink" title="debug ç”¨äºè°ƒè¯• åŒæ—¶å¯ä»¥çœ‹åˆ°è°ƒæ ˆæ¶ˆè€—çš„æ—¶é—´"></a>debug ç”¨äºè°ƒè¯• åŒæ—¶å¯ä»¥çœ‹åˆ°è°ƒæ ˆæ¶ˆè€—çš„æ—¶é—´</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'request'</span>);</span><br><span class="line">debug(<span class="string">'1'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testTime</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    debug(<span class="string">'3'</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line">debug(<span class="string">'2'</span>);</span><br><span class="line">testTime();</span><br><span class="line"></span><br><span class="line"><span class="comment">// debug('ç»“æŸæ—¶é—´1');</span></span><br><span class="line"><span class="comment">// debug('ç»“æŸæ—¶é—´2');</span></span><br><span class="line"><span class="comment">// debug('ç»“æŸæ—¶é—´3');</span></span><br><span class="line"><span class="comment">// debug('ç»“æŸæ—¶é—´4');</span></span><br><span class="line"><span class="comment">// debug('ç»“æŸæ—¶é—´5');</span></span><br></pre></td></tr></table></figure>

<h2 id="on-finished-http-è¯·æ±‚ç»“æŸ-å®Œæˆ-æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ"><a href="#on-finished-http-è¯·æ±‚ç»“æŸ-å®Œæˆ-æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ" class="headerlink" title="on-finished http è¯·æ±‚ç»“æŸ å®Œæˆ æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ"></a>on-finished http è¯·æ±‚ç»“æŸ å®Œæˆ æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'../'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">let</span> onFinished = <span class="built_in">require</span>(<span class="string">'on-finished'</span>);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'heh'</span>;</span><br><span class="line">  onFinished(ctx, (err, res) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'11'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'ç›‘å¬å¥½äº†'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>const isJSON = require(â€˜koa-is-jsonâ€™); //åˆ¤æ–­è¿”å›çš„æ•°æ®æ˜¯ä¸æ˜¯ json body</p>
</blockquote>
<h2 id="statuses-çŠ¶æ€-ğŸ"><a href="#statuses-çŠ¶æ€-ğŸ" class="headerlink" title="statuses çŠ¶æ€ ğŸ"></a>statuses çŠ¶æ€ ğŸ</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> status = <span class="built_in">require</span>(<span class="string">'statuses'</span>);</span><br><span class="line"></span><br><span class="line">status(<span class="number">403</span>); <span class="comment">// =&gt; 403</span></span><br><span class="line">status(<span class="string">'403'</span>); <span class="comment">// =&gt; 403</span></span><br><span class="line">status(<span class="string">'forbidden'</span>); <span class="comment">// =&gt; 403</span></span><br><span class="line">status(<span class="string">'Forbidden'</span>); <span class="comment">// =&gt; 403</span></span><br><span class="line">status(<span class="number">306</span>);</span><br></pre></td></tr></table></figure>

<h2 id="only-ç™½åå•è®¾ç½®-ç±»ä¼¼æ²™ç›’"><a href="#only-ç™½åå•è®¾ç½®-ç±»ä¼¼æ²™ç›’" class="headerlink" title="only ç™½åå•è®¾ç½® ç±»ä¼¼æ²™ç›’"></a>only ç™½åå•è®¾ç½® ç±»ä¼¼æ²™ç›’</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> only = <span class="built_in">require</span>(<span class="string">'only'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  name: <span class="string">'tobi'</span>,</span><br><span class="line">  last: <span class="string">'holowaychuk'</span>,</span><br><span class="line">  email: <span class="string">'tobi@learnboost.com'</span>,</span><br><span class="line">  _id: <span class="string">'12345'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> user = only(obj, <span class="string">'name last email'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(user);</span><br><span class="line"><span class="comment">/*&#123;</span></span><br><span class="line"><span class="comment"> name: 'tobi',</span></span><br><span class="line"><span class="comment"> last: 'holowaychuk',</span></span><br><span class="line"><span class="comment"> email: 'tobi@learnboost.com'</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="applicaion-ç±»-å…¥å£ç±»"><a href="#applicaion-ç±»-å…¥å£ç±»" class="headerlink" title="applicaion ç±» å…¥å£ç±»"></a>applicaion ç±» å…¥å£ç±»</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Emitter</span> </span>&#123;</span><br><span class="line">  <span class="comment">//ç»§æ‰¿äº Emitter å¯¹è±¡</span></span><br><span class="line">  <span class="comment">//todo....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‡½æ•°å†…éƒ¨åˆ†æ"><a href="#å‡½æ•°å†…éƒ¨åˆ†æ" class="headerlink" title="å‡½æ•°å†…éƒ¨åˆ†æ"></a>å‡½æ•°å†…éƒ¨åˆ†æ</h3><blockquote>
<p>constructor æ„é€ å™¨ åˆå§‹åŒ–</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Initialize a new `Application`.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @api public</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>(); <span class="comment">// ç»§æ‰¿çˆ¶å…ƒç´ çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">this</span>.proxy = <span class="literal">false</span>; <span class="comment">// å½“çœŸæ­£çš„ä»£ç†å¤´å­—æ®µå°†è¢«ä¿¡ä»»æ—¶</span></span><br><span class="line">    <span class="keyword">this</span>.middleware = []; <span class="comment">// å­˜æ”¾ä¸­é—´ä»¶çš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">this</span>.subdomainOffset = <span class="number">2</span>; <span class="comment">// å­åŸŸååç§»è®¾ç½® å¯¹äºè¦å¿½ç•¥çš„ .subdomains åç§»[2]</span></span><br><span class="line">    <span class="keyword">this</span>.env = process.env.NODE_ENV || <span class="string">'development'</span>; <span class="comment">// è¯»å–ç¯å¢ƒå˜é‡ é»˜è®¤æ˜¯ NODE_ENV æˆ– "development"</span></span><br><span class="line">    <span class="keyword">this</span>.context = <span class="built_in">Object</span>.create(context); <span class="comment">// å®ä¾‹åŒ–ä¸‰ä¸ªå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">this</span>.request = <span class="built_in">Object</span>.create(request);</span><br><span class="line">    <span class="keyword">this</span>.response = <span class="built_in">Object</span>.create(response);</span><br><span class="line">    <span class="keyword">if</span> (util.inspect.custom) &#123;</span><br><span class="line">      <span class="comment">// è¿™æ®µåªæ˜¯ä¸ºäº†éšè—è¾“å‡ºä¿¡æ¯  åªæš´éœ²ä¸€äº›æƒ…å†µ</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.inspect, util.inspect.custom); <span class="comment">// [Function: inspect] Symbol(nodejs.util.inspect.custom)</span></span><br><span class="line">      <span class="keyword">this</span>[util.inspect.custom] = <span class="keyword">this</span>.inspect; <span class="comment">// åªè¾“å‡ºç™½åå•çš„ä¸œè¥¿  é‡å†™äº† å‡½æ•°çš„æ˜¾ç¤ºè®¾ç½®</span></span><br><span class="line">      <span class="built_in">console</span>.log();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>listen èµ·æœåŠ¡</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  http è¿™æ ·å¼€å¯æœåŠ¡çš„</span></span><br><span class="line"><span class="comment">// var http = require('http');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// http.createServer(function (request, response) &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     // å‘é€ HTTP å¤´éƒ¨</span></span><br><span class="line"><span class="comment">//     // HTTP çŠ¶æ€å€¼: 200 : OK</span></span><br><span class="line"><span class="comment">//     // å†…å®¹ç±»å‹: text/plain</span></span><br><span class="line"><span class="comment">//     response.writeHead(200, &#123;'Content-Type': 'text/plain'&#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     // å‘é€å“åº”æ•°æ® "Hello World"</span></span><br><span class="line"><span class="comment">//     response.end('Hello World\n');</span></span><br><span class="line"><span class="comment">// &#125;).listen(8888);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// // ç»ˆç«¯æ‰“å°å¦‚ä¸‹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">// console.log('Server running at http://127.0.0.1:8888/');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//koa æ˜¯è¿™æ ·çš„  å°è£…äº†ä¸€å±‚</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Shorthand for:</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *    http.createServer(app.callback()).listen(...)</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param &#123;Mixed&#125; ...</span></span><br><span class="line"><span class="comment">   * @return &#123;Server&#125;</span></span><br><span class="line"><span class="comment">   * @api public</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  listen(...args) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ç›‘å¬æ–¹æ³•</span></span><br><span class="line">    <span class="built_in">console</span>.log(args); <span class="comment">// [ 3002, [Function] ]   3002æ˜¯ç«¯å£å· [Function] æ˜¯å®šä¹‰å¯åŠ¨åçš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    debug(<span class="string">'listen'</span>);</span><br><span class="line">    <span class="keyword">const</span> server = http.createServer(<span class="keyword">this</span>.callback()); <span class="comment">// åˆ›å»ºä¸€ä¸ªæœåŠ¡  callback ä¸‹ä¸€æ­¥è®²</span></span><br><span class="line">    <span class="keyword">return</span> server.listen(...args);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>toJSON inspect è®¾ç½®ç™½åå•</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return JSON representation.</span></span><br><span class="line"><span class="comment"> * We only bother showing settings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">toJSON() &#123;</span><br><span class="line">  <span class="keyword">return</span> only(<span class="keyword">this</span>, [<span class="string">'subdomainOffset'</span>, <span class="string">'proxy'</span>, <span class="string">'env'</span>]); <span class="comment">// åªè¿”å›ç™½åå•çš„ä¸œè¥¿ ,åœ¨inspectæœ‰è°ƒç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Inspect implementation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">inspect() &#123;  <span class="comment">// åœ¨constructoræœ‰è°ƒç”¨</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.toJSON();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>use è£…è½½ä¸­é—´ä»¶</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Use the given middleware `fn`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Old-style middleware will be converted.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;Function&#125; fn</span></span><br><span class="line"><span class="comment"> * @return &#123;Application&#125; self</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">use(fn) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function!'</span>);</span><br><span class="line">  &#125; <span class="comment">// å…ˆæ£€æŸ¥ä¼ çš„æ˜¯ä¸æ˜¯fn</span></span><br><span class="line">  <span class="keyword">if</span> (isGeneratorFunction(fn)) &#123;</span><br><span class="line">    <span class="comment">// ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ç”Ÿæˆå™¨æ¥åšå¼‚æ­¥ ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹è¿™ç±»ä¸­é—´ä»¶è¿›è¡Œè½¬æ¢ å˜æˆ async await</span></span><br><span class="line">    deprecate(</span><br><span class="line">      <span class="string">'Support for generators will be removed in v3. '</span> +</span><br><span class="line">        <span class="string">'See the documentation for examples of how to convert old middleware '</span> +</span><br><span class="line">        <span class="string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span></span><br><span class="line">    );</span><br><span class="line">    fn = convert(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</span><br><span class="line">  <span class="keyword">this</span>.middleware.push(fn); <span class="comment">// ç„¶åæ”¾åˆ°ä¸­é—´ä»¶æ ˆé‡Œé¢å»</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>callback è¿™ä¸ªç›¸å½“äºåŸç”Ÿçš„ requset å›è°ƒ</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return a request handler callback</span></span><br><span class="line"><span class="comment"> * for node's native http server.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return &#123;Function&#125;</span></span><br><span class="line"><span class="comment"> * @api public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">callback() &#123;</span><br><span class="line">  <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware); <span class="comment">// åˆå¹¶æ‰€æœ‰çš„ä¸­é—´ä»¶</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listenerCount(<span class="string">'error'</span>)) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror); <span class="comment">//  this.listenerCount('error') æ²¡æ³¨å†Œerroræ—¶  æˆ‘ä»¬è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res); <span class="comment">// ä¼ åŸå§‹çš„req,res è¿›è¡Œå°è£…  æœ€åè¿”å›ä¸€ä¸ªå°è£…å¥½çš„ctxå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.handleRequest(ctx, fn); <span class="comment">// æœ€åä¼ åˆ°çœŸæ­£çš„handleRequest å‡½æ•°è¿›è¡Œå¤„ç†</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> handleRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>handleRequest äº‹ä»¶å¤„ç†</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle request in callback.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @api private</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">handleRequest(ctx, fnMiddleware) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">  res.statusCode = <span class="number">404</span>;</span><br><span class="line">  <span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err); <span class="comment">// ä¸€ä¸ªé”™è¯¯å¤„ç†å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx); <span class="comment">// ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•° å®Œæˆæ‰€æœ‰ä¸­é—´ä»¶åçš„å›è°ƒ</span></span><br><span class="line">  onFinished(res, onerror); <span class="comment">// è¯·æ±‚ç»“æŸ å®Œæˆ æˆ–è€…æŠ¥é”™çš„æ—¶å€™å›è°ƒ</span></span><br><span class="line">  <span class="keyword">return</span> fnMiddleware(ctx)</span><br><span class="line">    .then(handleResponse)</span><br><span class="line">    .catch(onerror); <span class="comment">// ä¸­é—´å®Œæˆåæ‰§è¡Œäº†respond æŠ¥é”™æ‰§è¡Œonerror</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆå§‹åŒ– ctx</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize a new context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @api private</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">createContext(req, res) &#123;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–æ–°çš„å¯¹è±¡  ä¿è¯ä¸ä¼šå‡ºç°ç›¸äº’å¹²æ‰°çš„æƒ…å†µ</span></span><br><span class="line">  <span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</span><br><span class="line">  <span class="keyword">const</span> request = (context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request));</span><br><span class="line">  <span class="keyword">const</span> response = (context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response));</span><br><span class="line">  context.app = request.app = response.app = <span class="keyword">this</span>;</span><br><span class="line">  context.req = request.req = response.req = req;</span><br><span class="line">  context.res = request.res = response.res = res;</span><br><span class="line">  request.ctx = response.ctx = context;</span><br><span class="line">  request.response = response;</span><br><span class="line">  response.request = request;</span><br><span class="line">  context.originalUrl = request.originalUrl = req.url; <span class="comment">// å±•ç¤ºçš„ä¸€è‡´çš„è¯·æ±‚url</span></span><br><span class="line">  context.state = &#123;&#125;; <span class="comment">// æ¨èçš„å‘½åç©ºé—´ï¼Œç”¨äºé€šè¿‡ä¸­é—´ä»¶ä¼ é€’ä¿¡æ¯å’Œä½ çš„å‰ç«¯è§†å›¾ã€‚</span></span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>onerror é”™è¯¯å¤„ç†æœºåˆ¶</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Default error handler.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param &#123;Error&#125; err</span></span><br><span class="line"><span class="comment">   * @api private</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  onerror(err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(util.format(<span class="string">'non-error thrown: %j'</span>, err));</span><br><span class="line">    &#125; <span class="comment">// å¦‚æœæ˜¯é”™è¯¯å¯¹è±¡ åˆ™ç›´æ¥æŠ›å‡º</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">404</span> == err.status || err.expose) <span class="keyword">return</span>; <span class="comment">// å½“ err.status æ˜¯ 404 æˆ– err.expose æ˜¯ true æ—¶é»˜è®¤é”™è¯¯å¤„ç†ç¨‹åºä¹Ÿä¸ä¼šè¾“å‡ºé”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.silent) <span class="keyword">return</span>; <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼Œå°†æ‰€æœ‰é”™è¯¯è¾“å‡ºåˆ° stderrï¼Œé™¤é app.silent ä¸º trueã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> msg = err.stack || err.toString(); <span class="comment">// string ç±»å‹çš„é”™è¯¯ç›´æ¥å±•ç¤ºåœ¨æ§åˆ¶å°</span></span><br><span class="line">    <span class="built_in">console</span>.error();</span><br><span class="line">    <span class="built_in">console</span>.error(msg.replace(<span class="regexp">/^/gm</span>, <span class="string">'  '</span>));</span><br><span class="line">    <span class="built_in">console</span>.error();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>response æœ€ç»ˆè¿”å›çš„å¤„ç†</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Response helper.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">respond</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// allow bypassing koa</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">false</span> === ctx.respond) <span class="keyword">return</span>; <span class="comment">// å¦‚ä¸æƒ³ä½¿ç”¨Koa å†…ç½®çš„response å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥è®¾ç½® ctx.respond = false;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!ctx.writable) <span class="keyword">return</span>; <span class="comment">// ï¼Ÿï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = ctx.res;</span><br><span class="line">  <span class="keyword">let</span> body = ctx.body;</span><br><span class="line">  <span class="keyword">const</span> code = ctx.status;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ignore body</span></span><br><span class="line">  <span class="keyword">if</span> (statuses.empty[code]) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾ä¸åˆ°çŠ¶æ€ç å°±è¿”å›null</span></span><br><span class="line">    <span class="comment">// strip headers</span></span><br><span class="line">    ctx.body = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> res.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'HEAD'</span> == ctx.method) &#123;</span><br><span class="line">    <span class="comment">// å½“è¯·æ±‚æ–¹æ³•ä¸º HEAD æ—¶ï¼Œåˆ¤æ–­å“åº”å¤´æ˜¯å¦å‘é€ä»¥åŠå“åº”ä¸»ä½“æ˜¯å¦ä¸º JSON æ ¼å¼ï¼Œè‹¥æ»¡è¶³åˆ™è®¾ç½®å“åº” Content-Lengthï¼š</span></span><br><span class="line">    <span class="keyword">if</span> (!res.headersSent &amp;&amp; isJSON(body)) &#123;</span><br><span class="line">      ctx.length = Buffer.byteLength(<span class="built_in">JSON</span>.stringify(body));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.end();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// status body</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == body) &#123;</span><br><span class="line">    <span class="comment">// çŠ¶æ€å¤´çš„åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.req.httpVersionMajor &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// åœ¨æœåŠ¡å™¨è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å‘é€çš„ HTTP ç‰ˆæœ¬ã€‚ åœ¨å®¢æˆ·ç«¯å“åº”çš„æƒ…å†µä¸‹ï¼Œè¡¨ç¤ºè¿æ¥åˆ°çš„æœåŠ¡å™¨çš„ HTTP ç‰ˆæœ¬ã€‚ å¯èƒ½æ˜¯ '1.1' æˆ– '1.0'ã€‚</span></span><br><span class="line">      body = <span class="built_in">String</span>(code);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      body = ctx.message || <span class="built_in">String</span>(code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">      <span class="comment">// å¸ƒå°”å€¼ï¼ˆåªè¯»ï¼‰ã€‚ å¦‚æœå·²å‘é€å“åº”å¤´ï¼Œåˆ™ä¸º trueï¼Œå¦åˆ™ä¸º falseã€‚</span></span><br><span class="line">      ctx.type = <span class="string">'text'</span>;</span><br><span class="line">      ctx.length = Buffer.byteLength(body);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.end(body);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// responses  //åˆ¤æ–­è¯·æ±‚æµ   äºŒè¿›åˆ¶  å­—ç¬¦ä¸² æµ  json</span></span><br><span class="line">  <span class="keyword">if</span> (Buffer.isBuffer(body)) <span class="keyword">return</span> res.end(body);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> body) <span class="keyword">return</span> res.end(body);</span><br><span class="line">  <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Stream) <span class="keyword">return</span> body.pipe(res);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// body: json</span></span><br><span class="line">  body = <span class="built_in">JSON</span>.stringify(body);</span><br><span class="line">  <span class="keyword">if</span> (!res.headersSent) &#123;</span><br><span class="line">    ctx.length = Buffer.byteLength(body);</span><br><span class="line">  &#125;</span><br><span class="line">  res.end(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
        </div> 
      </article> 
</div>



    </main>
    </div>
  </body>
</html>